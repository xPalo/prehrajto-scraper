<div class="container my-5">
  <div class="card loaded shadow-sm <%= @dark_mode ? 'bg-dark text-white' : '' %>">
    <div class="card-body">
      <h2 class="card-title mb-4"><%= @video.original_filename %></h2>

      <ul class="list-unstyled">
        <li>
          <strong><%= t('video.status_label') %>:</strong>
          <span id="video-status" class="badge <%= video_status_badge_class(@video.status) %>">
            <%= t("video.status_#{@video.status}") %>
          </span>
        </li>

        <% if @video.file_size.present? %>
          <li><strong><%= t('video.file_size') %>:</strong> <%= number_to_human_size(@video.file_size) %></li>
        <% end %>

        <% if @video.duration.present? && @video.duration > 0 %>
          <li><strong><%= t('video.duration') %>:</strong> <%= Time.at(@video.duration).utc.strftime("%H:%M:%S") %></li>
        <% end %>

        <li><strong><%= t('created_at') %>:</strong> <%= l(@video.created_at, format: :long) %></li>

        <% if @video.failed? && @video.error_message.present? %>
          <li class="text-danger mt-2">
            <strong><%= t('video.error') %>:</strong> <%= @video.error_message %>
          </li>
        <% end %>
      </ul>

      <div id="video-actions" class="mt-3">
        <% if @video.completed? && @video.stabilized_video.attached? %>
          <%= link_to t('video.download'), download_video_path(@video), class: "btn btn-success rounded-pill" %>
        <% elsif @video.pending? || @video.processing? %>
          <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status" id="video-spinner">
              <span class="visually-hidden">Processing...</span>
            </div>
            <span id="video-processing-text"><%= t('video.processing_message') %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="mt-4 d-flex gap-2">
    <%= link_to t('back'), videos_path, class: "btn btn-outline-secondary rounded-pill" %>
    <%= button_to t('delete'), video_path(@video), method: :delete, data: { confirm: t('delete_confirm') }, class: "btn btn-outline-danger rounded-pill" %>
  </div>
</div>

<% if @video.pending? || @video.processing? %>
  <script type="text/javascript">
    $(document).on("turbo:load", function() {
      var videoId = <%= @video.id %>;
      var pollInterval = setInterval(function() {
        $.getJSON("/videos/" + videoId + ".json", function(data) {
          var $status = $('#video-status');
          var $actions = $('#video-actions');

          if (data.status === 'completed') {
            clearInterval(pollInterval);
            $status.removeClass().addClass('badge bg-success').text('<%= j t("video.status_completed") %>');
            $actions.html('<a href="' + data.download_url + '" class="btn btn-success rounded-pill"><%= j t("video.download") %></a>');
          } else if (data.status === 'failed') {
            clearInterval(pollInterval);
            $status.removeClass().addClass('badge bg-danger').text('<%= j t("video.status_failed") %>');
            var errorMsg = data.error_message || '<%= j t("video.unknown_error") %>';
            $actions.html('<span class="text-danger"><strong><%= j t("video.error") %>:</strong> ' + errorMsg + '</span>');
          } else if (data.status === 'processing') {
            $status.removeClass().addClass('badge bg-warning text-dark').text('<%= j t("video.status_processing") %>');
          }
        });
      }, 5000);
    });
  </script>
<% end %>
